<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
    <head>
        <meta http-equiv="Content-Language" content="en-ca">
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="style.css" type="text/css"> 
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            $(function(){
                var updateInterval = 1000; 
                var iosocket = io.connect();
                $('#clientTime').text((new Date()).toLocaleString());
     
                iosocket.on('connect', function () {
                    $('#connectionStatus').text('Connected');
                    
                    var updateLoop = setInterval( function() {
                        var localDate = new Date();
                        $('#clientTime').text(localDate.toLocaleString());
                        iosocket.send(localDate);
                    }, updateInterval);
     
                    iosocket.on('serverTime', function(objDate) {
                        $('#serverTime').text((new Date(objDate)).toLocaleString());
                    });
                    iosocket.on('clientTime', function(clientTimeDelimited) {
                        var client = clientTimeDelimited.split(',')[0];
                        var clientId = client.replace(/\./g, "_").replace(/:/g, "__")
                        var clientTime = clientTimeDelimited.split(',')[1];
                        var clientElem = $('#' + clientId);
                        
                        if( clientTime == 0 )
                            clientElem.remove();
                        else
                        {
                            if( clientElem.length == 0 )
                            {
                                $('#peerTimes').append($('<li id="' + clientId + '"></li>'));
                                clientElem = $('#' + clientId);
                            }
                            clientElem.empty();
                            clientElem.append($('<span class="ip" title="Port ' + client.split(':')[1] + '" ></span>').text(client.split(':')[0]));
                            clientElem.append($('<span class="dateTime time"></span>').text((new Date(clientTime)).toLocaleString()));
                        }
                    });                        
                    iosocket.on('disconnect', function() {
                        $('#connectionStatus').text('Disconnected');
                        $('#peerTimes').empty();
                    });
                    
                    
                });
                
            });
        </script>
        <title>Node.js Time Server</title>
    </head>
    <body>
        Status: <span id="connectionStatus">Disconnected</span><br><br>
        Server Time: <span id="serverTime" class="time">?</span><br><br>
        Client Time: <span id="clientTime" class="time">?</span><br><br>
        <strong>Peers</strong>
        <ol id="peerTimes"></ol>
    </body>
</html>